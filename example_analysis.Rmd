---
title: "Beispielanalyse von Daten aus Party Check"
author: "Sören Müller-Hansen"
date: "August 2025"
output:
  html_document:
    code_folding: show
    df_print: kable
    toc: yes
    toc_depth: 4
    toc_float: 
      collapsed: false
      smooth_scroll: false
---

## Konfiguration und Daten laden

```{r echo=F, message=F, warning=F}
source("scripts/config.R")

# Daten des Euro Party Check herunterladen ####
eupc_folder <- download_euro_party_check(doi = "10.7910/DVN/7PBJS9")

# Gewichte für jede Gruppe auf Basis von Zensus-Daten berechnen ####
source(here("scripts", "weight_data.R"))

# annähernd repräsentative Stichprobe mit 2000 User:innen aus dem Party Check Datensatz ziehen ####
source(here("scripts", "calculate_quota_sample.R"))

# Codebook laden ####
# Vorsicht, Codebook wurde mit Hilfe von KI erstellt und nicht vollständig geprüft!
eupc_codebook <- read_csv(here("input", "codebook_eu_party_check.csv"))

# Parteifarben definieren
party_colors <- c("AfD" = "#209fc9","CDU/CSU" = "#333333", "CDU" = "#333333", "CSU" = "#333333", "FDP" = "#ffd324", "Grüne" = "#4daa65", "Die Linke" = "#d1478c", "Linke" = "#d1478c", "SPD" = "#f45151", "Freie Wähler" = "#ea8b0c", "FW" = "#ea8b0c", "BVB/FW" = "#ea8b0c", "BSW" = "#9671bc", "Volt" = "#893b96", "Sonstige" = "#A0A0A0")
```

# Analyse

## Daten für die Analyse vorbereiten

```{r data preparation}
# Daten werden hier in weight_data.R geladen und vorbereitet
# hier nur ein Auszug aus den verfügbaren Items
items <- c(
  "lrgen",                # generelle politische Orientierung
  "econinterven",         # Sollte der Staat in die Wirtschaft eingreifen?
  "environment",          # Umwelt- und Klimaschutz vor Wirtschaft?
  "protectionism",        # Freihandel oder Protektionismus?
  "redistribution",       # Soll der Staat umverteilen?
  "eucohesion",           # Soll die EU mehr Geld für ärmere Regionen ausgeben?
  "euenlargement",        # Soll die EU weiter wachsen?
  "euforeign",            # Soll die EU eine gemeinsame Außenpolitik haben?
  "euintegrationtoofar",  # Ist die EU-Integration zu weit fortgeschritten?
  "euposition",           # Generelle Haltung zur EU
  "civliblaworder",       # Bürgerrechte vs. Sicherheit
  "immigratepolicy",      # Einwanderungspolitik
  "lgb",                  # Einstellung zu LGBTQ+ Themen
  "multiculturalism",     # Einstellung zu Multikulturalismus
  "trans"                 # Transgender Rechte
)

sociodemography <- c(
  "gender",               # Geschlecht
  "bundesland",           # Bundesland
  "age",                  # Alter
  "education",            # Bildungsniveau
  "university",           # Hochschulbildung (1=ja, 2=nein)
  "recall",               # gewählte Partei (Zweitstimme) bei der Bundestagswahl 2021
  "recallland",           # gewählte Partei (Zweitstimme) bei der Landtagswahl 2019, nur für Befragte in Brandenburg, Thüringen und Sachsen
  "recallland_other",     # andere Partei bei der Landtagswahl 2019, nur für Befragte in Brandenburg, Thüringen und Sachsen
  "votinteu",             # Wahlabsicht (Partei) bei der Europawahl 2024
  "votint",               # Wahlabsicht (Partei) bei der Bundestagswahl 2025
  "urbanrurallive",       # Selbsteinschätzung der Größe des Wohnorts
  "socself"               # Soziale Selbstidentifikation (1=konservativ, 11=progressiv)
)

party_proxy_items <- c( # Frage nach der Wahrscheinlichkeit, in Zukunft die Partei zu wählen
  "ptv_spd", "ptv_cdu", "ptv_csu", "ptv_greens", "ptv_fdp", "ptv_fdp", "ptv_left", "ptv_bsw", "ptv_freevoters", "ptv_volt", "ptv_climatelist"
)

# Daten in langes Format bringen
pc_data_long <- pc_data_final %>%
  pivot_longer(cols = -c(all_of(c("id", "startdate", "datestamp", sociodemography, party_proxy_items, "w"))),
               names_to = "item",
               values_to = "value",
               values_transform = list(value = as.character))

# Geschlecht, Bundesland, Alter etc. umcodieren
# sociodemography ohne recallland_other und socself
for (item in setdiff(sociodemography, c("recallland_other", "socself"))) {
  if (item %in% names(pc_data_long)) {
    pc_data_long <- pc_data_long %>%
      recode_with_codebook(item, eupc_codebook)
  }
}

head(pc_data_long)
```

## Statistische Kennzahlen für ausgewählte Items und soziodemographische Gruppen berechnen

```{r stats}
pc_stats_df <- calculate_pc_stats(df = pc_data_long,
                                  items_list = items, 
                                  sociodemography_list = c("gender", "bundesland", "age"), 
                                  with_weights = TRUE)

pc_stats_df
```

### nach Parteipräferenz (Wahlabsicht 2025)

```{r stats votint}
calculate_pc_stats(pc_data_long,
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("votint"),
                   with_weights = TRUE)
```

### nach Parteipräferenz (Wahlabsicht 2025) und Wahlentscheidung BTW21

```{r stats votint recall}
calculate_pc_stats(pc_data_long,
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("votint", "recall"),
                   with_weights = TRUE) %>%
  filter(n >= 20)
```

### nach Alter und Parteipräferenz (Wahlabsicht 2025)

```{r stats votint age}
calculate_pc_stats(pc_data_long,
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("age", "votint"),
                   with_weights = TRUE)
```

### nach Alter (grob jung und alt) und Parteipräferenz (Wahlabsicht 2025)

```{r stats votint age grouped}
calculate_pc_stats(pc_data_long %>%
                     mutate(age = case_when(
                       age %in% (eupc_codebook %>%
                                   filter(item == "age") %>%
                                   mutate(value = as.integer(value)) %>%
                                   filter(value < 5 | value == 98) %>%
                                   pull(text)
                                 ) ~ "unter 30 Jahre",
                       age %in% (eupc_codebook %>%
                                   filter(item == "age") %>%
                                   mutate(value = as.integer(value)) %>%
                                   filter(value > 10, value < 98) %>%
                                   pull(text)
                                 ) ~ "über 60 Jahre",
                       age %in% (eupc_codebook %>%
                                   filter(item == "age") %>%
                                   mutate(value = as.integer(value)) %>%
                                   filter(value %in% 5:10) %>%
                                   pull(text)
                                 ) ~ "30 bis 59 Jahre")),
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("age", "votint"),
                   with_weights = TRUE) %>%
  arrange(item, factor(age, levels = c("unter 30 Jahre", "30 bis 59 Jahre", "über 60 Jahre")))
```

### nach Stadt/Land (Wahlabsicht 2025)

```{r stats votint urban rural}
calculate_pc_stats(pc_data_long %>%
                     mutate(urbanrurallive = case_when(urbanrurallive %in% (eupc_codebook %>% filter(item == "urbanrurallive") %>% mutate(value = as.integer(value)) %>% filter(value <= 3) %>% pull(text)) ~ "Stadt",
                                                       urbanrurallive %in% (eupc_codebook %>% filter(item == "urbanrurallive") %>% mutate(value = as.integer(value)) %>% filter(value > 3) %>% pull(text)) ~ "Land")),
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("votinteu", "urbanrurallive"),
                   with_weights = TRUE) %>%
  arrange(item, votinteu, urbanrurallive) %>%
  filter(n >= 20)
```

## alternative Gewichtung z.B. nach repräsentativer Wahlstatistik (Stimmen nach Altersgruppe)

```{r election result weights}
eu_wahlstatistik <- read_csv2("https://www.bundeswahlleiterin.de/dam/jcr/94c9a6f3-37aa-448d-9f52-afb592d8cf7a/ew24_rws_est2.csv",
                              skip = 11)
eu_wahlbeteiligung <- read_csv2("https://www.bundeswahlleiterin.de/dam/jcr/255d85ae-ef1f-4be3-9add-ef24bbbaaf4e/ew24_rws_ew2.csv",
                                skip = 11)

# wir wählen nur die wichtigsten Parteien > 2 % aus
eu_wahlstatistik_selected <- eu_wahlstatistik %>%
  # CDU und CSU aufsummieren
  group_by(Geburtsjahresgruppe, Land, Geschlecht) %>%
  mutate("CDU/CSU" = sum(CDU, CSU, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_longer(cols= -c(1:4), names_to = "party", values_to = "votes") %>%
  mutate(pct = votes / Summe) %>%
  filter(pct > 0.02,
         !party %in% c("CDU", "CSU", "Sonstige")) %>%
  mutate(party = case_when(
    party %in% c("GRÜNE", "DIE LINKE") ~ str_to_title(party),
    party == "dar. BSW" ~ "BSW",
    party == "dar. FREIE WÄHLER" ~ "Freie Wähler",
    TRUE ~ party
  ))

# Altersgruppen in pc_data_long anpassen
pc_data_age_groups <- pc_data_long %>%
  mutate(age_group = case_when(
    age %in% c("16-17 years", "18 - 20 years", "21 - 24 years") ~ "16-24 Jahre",
    age %in% c("25 - 29 years", "30 - 34 years") ~ "25-34 Jahre",
    age %in% c("35 - 39 years", "40 - 44 years") ~ "35-44 Jahre",
    age %in% c("45 - 49 years", "50 - 54 years", "55 - 59 years") ~ "45-59 Jahre",
    age %in% c("60 - 64 years", "65 - 69 years") ~ "60-69 Jahre",
    age %in% c("70 - 74 years", "75 - 79 years", "80 years and older") ~ "70 Jahre und älter"
  )) %>%
  drop_na(age_group, votinteu)

pc_data_eu_weights <- pc_data_age_groups %>%
  dplyr::select(id, age_group, votinteu) %>%
  group_by(age_group, votinteu) %>%
  reframe(n = n()) %>%
  mutate(freq = n / sum(n))

# Geburtsjahresgruppen in Altersgruppen übersetzen (für 2024)
eu_wahlstatistik_age_groups <- eu_wahlstatistik_selected %>%
  filter(Geburtsjahresgruppe != "Summe",
         Land == "Bund",
         Geschlecht == "Summe") %>%
  mutate(age_group = case_when(
    Geburtsjahresgruppe == "2000 - 2008" ~ "16-24 Jahre",
    Geburtsjahresgruppe == "1990 - 1999" ~ "25-34 Jahre",
    Geburtsjahresgruppe == "1980 - 1989" ~ "35-44 Jahre",
    Geburtsjahresgruppe == "1965 - 1979" ~ "45-59 Jahre",
    Geburtsjahresgruppe == "1955 - 1964" ~ "60-69 Jahre",
    Geburtsjahresgruppe == "<=1954" ~ "70 Jahre und älter"
    ),
    size_age_group_pct = Summe / sum(Summe[party == "SPD"])) %>%
  dplyr::select(age_group, votinteu = party, pct, size_age_group_pct)

# jetzt können wir nach der Spalte votinteu (Wahlabsicht bei der Europawahl 2024) und dem Wahlergebnis gewichten
pc_data_eu_weights <- pc_data_eu_weights %>%
  left_join(eu_wahlstatistik_age_groups, by = c("age_group", "votinteu")) %>%
  mutate(weight_total = pct / freq * size_age_group_pct,
         weight_age_group = pct / freq) %>%
  drop_na(freq, pct)

pc_data_long_eu_weights <- pc_data_age_groups %>%
  left_join(pc_data_eu_weights %>%
              select(age_group, votinteu, weight_total, weight_age_group),
            by = join_by(age_group, votinteu)) %>%
  drop_na(weight_total, weight_age_group)
```

### nach Wahlabsicht Europawahl und Altersgruppe

```{r stats votinteu age group eu weights}
calculate_pc_stats(pc_data_long_eu_weights,
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("votinteu", "age_group"),
                   with_weights = TRUE, weight_column = "weight_age_group") %>%
  arrange(item, votinteu, age_group) %>%
  filter(n >= 20)
```

### nach Wahlabsicht Europawahl

```{r stats votinteu eu weights}
calculate_pc_stats(pc_data_long_eu_weights,
                   items_list = c("lrgen", "econinterven", "immigratepolicy", "environment", "protectionism"),
                   sociodemography_list = c("votinteu"),
                   with_weights = TRUE, weight_column = "weight_total") %>%
  arrange(item, votinteu) %>%
  filter(n >= 20)
```

### Sind bestimmte Themen jungen und alten Menschen unterschiedlich wichtig?

```{r stats salience}
pc_data_long_eu_weights %>%
  mutate(age_group = case_when(
    age_group %in% c("16-24 Jahre", "24-34 Jahre") ~ "unter 35",
    TRUE ~ "über 35"
  )) %>%
  calculate_pc_stats(items_list = pc_data_long_eu_weights %>% filter(str_starts(item, "sal"), !str_detect(item, "eu")) %>% pull(item) %>% unique(),
                     sociodemography_list = "age_group",
                     with_weights = TRUE,
                     weight_column = "weight_age_group") %>%
  select(item, age_group, mean_weighted) %>%
  pivot_wider(names_from = age_group, values_from = mean_weighted) %>%
  arrange(desc(`unter 35`)) %>%
  mutate(difference = `unter 35` - `über 35`,
         across(2:4, ~ round(., 1)))
```

# Visualisierung

## Klima/Wirtschaft nach Wahlabsicht (Europawahl 2024)

```{r votinteu viz}
calculate_pc_stats(pc_data_long,
                   items_list = c("environment"),
                   sociodemography_list = c("votinteu"),
                   with_weights = TRUE) %>% filter(n >= 100) %>%
  select(votinteu, mean_weighted) %>%
  mutate(mean_weighted = scales::rescale(mean_weighted, from = c(1,11), to = c(0,10))) %>%
  ggplot(aes(x = mean_weighted, y = votinteu)) +
  geom_col(aes(fill = votinteu), show.legend = FALSE) +
  scale_fill_manual(values = party_colors) +
  scale_x_continuous(breaks = seq(0, 10, by = 1), limits = c(0, 10)) +
  labs(title = "Gewichtete Verteilung der Einstellung zu Umwelt- und Klimaschutz",
       x = "Wert (1-11)",
       y = "Wahlabsicht Europawahl 2024") +
  theme_minimal()
```

## Wie unterschiedlich Männer und Frauen Zuwanderung betrachten (Density Plot)

```{r immigratepolicy gender}
density_plot <- ggplot(pc_data_long_eu_weights %>%
         filter(item == "immigratepolicy",
                gender %in% c("Woman", "Man")) %>%
         drop_na(value) %>%
         mutate(value = as.numeric(value)), aes(x = value, weight = weight_age_group, fill = gender)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ age_group) +
  labs(
    title = "Gewichtete Verteilung nach Altersgruppe und Wahlabsicht",
    x = "Wert (1-11)",
    y = "Dichte",
    fill = "Geschlecht"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set1") +
  # x-Achse von 1 bis 11
  scale_x_continuous(breaks = 1:11, limits = c(1, 11))

# Daten für Visualisierung in anderem Tool extrahieren
# ggplot_build(density_plot)$data[[1]] %>%
#   dplyr::select(x, y, PANEL, group, ymax) %>%
#   mutate(age_gender = case_when(PANEL == 1 & group == 1 ~ "Mann, U25",
#                                 PANEL == 1 & group == 2 ~ "Frau, U25",
#                                 PANEL == 6 & group == 1 ~ "Mann, Ü70",
#                                 PANEL == 6 & group == 2 ~ "Frau, Ü70"),
#          ymax = ymax * 100) %>%
#   dplyr::select(x, age_gender, ymax) %>%
#   as_tibble() %>%
#   filter(age_gender %in% c("Mann, U25", "Frau, U25")) %>%
#   pivot_wider(names_from = age_gender, values_from = ymax)

# density plot zeigen
print(density_plot)
```

## Klimaschutz oder Wirtschaft? Altersgruppen und Parteien im Vergleich

```{r environment age group votinteu}
environment_plot <- ggplot(pc_data_long_eu_weights %>%
         filter(item == "environment",
                votinteu %in% c("CDU/CSU", "AfD", "SPD", "Grüne", "Die Linke")) %>%
         drop_na(value) %>%
         mutate(value = as.numeric(value)), aes(x = value, weight = weight_age_group, fill = votinteu)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ age_group) +
  labs(
    title = "Gewichtete Verteilung nach Altersgruppe und Wahlabsicht",
    x = "Wert (1-11)",
    y = "Dichte",
    fill = "Wahlabsicht"
  ) +
  theme_minimal() +
  scale_fill_manual(values = party_colors) +
  # x-Achse von 1 bis 11
  scale_x_continuous(breaks = 1:11, limits = c(1, 11))

print(environment_plot)
```

## Wie unterschiedlich Parteianhänger:innen zur Marktwirtschaft stehen

Große staatliche Eingriffe in die Wirtschaft oder freie Marktwirtschaft?

```{r econinterven votinteu}
pc_data_long_eu_weights %>%
  filter(item == "econinterven",
         votinteu %in% c("CDU/CSU", "AfD", "SPD", "Grüne", "BSW", "FDP", "Die Linke")) %>%
  drop_na(votinteu) %>%
  mutate(value = as.numeric(value)) %>%
  ggplot(aes(x = value, y = votinteu, fill = votinteu, color = votinteu)) +
  geom_violin(scale = "area", drop = FALSE) +
  theme(axis.text.x = element_blank()) +
  labs(title = "Euro Party Check",
       x = "econinterven",
       y = "") +
  scale_fill_manual(values = party_colors) +
  scale_color_manual(values = party_colors) +
  scale_y_discrete(limits = c("AfD", "CDU/CSU", "BSW", "FDP", "SPD", "Grüne", "Die Linke") %>% rev()) +
  theme_minimal()
```
